# .gitlab-ci.yml

stages:
  - lint
  - test
  - build
  - publish

variables:
  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ Node.js
  NODE_VERSION: "18.20.4"
  
  # ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ node_modules Ğ´Ğ»Ñ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ñ
  CACHE_POLICY: pull-push

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ĞºĞµÑˆĞ°
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
  policy: $CACHE_POLICY

# ĞĞ±Ñ€Ğ°Ğ· Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
default:
  image: node:$NODE_VERSION
  before_script:
    - node --version
    - npm --version
    - npm ci --cache .npm --prefer-offline

# --- STAGE 1: Ğ›Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³ ---
lint:
  stage: lint
  script:
    - echo "ğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº ESLint..."
    - npm run lint
  artifacts:
    when: always
    reports:
      junit: reports/junit/lint.xml
    expire_in: 1 week
  only:
    refs:
      - main
      - merge_requests

# --- STAGE 2: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ---
test:
  stage: test
  script:
    - echo "ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²..."
    - npm test -- --coverage --coverageReporters=lcov
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - coverage/
    reports:
      junit: reports/junit/test.xml
    expire_in: 1 week
  only:
    refs:
      - main
      - merge_requests

# --- STAGE 3: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ---
build:
  stage: build
  script:
    - echo "ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°..."
    - npm run build
  artifacts:
    paths:
      - dist/
      - lib/
      - index.js
    expire_in: 1 week
  only:
    refs:
      - main
      - merge_requests
      - tags

# --- STAGE 4: ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ² NPM ---
publish:
  stage: publish
  script:
    - echo "ğŸš€ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ² NPM..."
    - |
      if [[ "$CI_COMMIT_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo "ğŸ“¦ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¸ $CI_COMMIT_TAG"
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        npm publish --access public
      else
        echo "ğŸ“¦ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞºĞ°Ğº 'next' Ğ²ĞµÑ€ÑĞ¸Ñ"
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        npm publish --access public --tag next
      fi
  dependencies:
    - build
  only:
    refs:
      - main
      - tags
    variables:
      - $NPM_TOKEN != null